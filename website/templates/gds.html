<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Upload GDS File</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
        <style>
            .topbar{
                width:100%;
                display:flex;
                flex-direction: row;
                background-color: #D9D9D9;
                border-bottom:groove #000;
                margin:0;
            }
            .topbar h1{
                color: #000;
                font-family: Inter;
                font-size: 24px;
                font-style: normal;
                font-weight: 600;
                line-height: normal;
                text-align: right;
                padding-left:50vw;
            }
            .topbar img{
                width: 228px;
                height: 52px; 
                flex-shrink:0;
            }
            body{
                background-color: #D9D9D9;
            }
            .inner-body{
                display:flex;
                flex-direction: row;
            }
            .whitespace{
                background-color: white;
                width:90vw;
                height:90vh;
            }
            .left-side-box{
                display:flex;
                flex-direction: column;
                border-right:solid black;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .left-side-box .File_input{
                color: #000;
                font-family: Inter;
                font-size: 24px;
                font-style: normal;
                font-weight: 300;
                line-height: normal;
            }
            .left-side-box .File_input .filepath{
                background-color: white;
            }
            .left-side-box a{
                color: #000;
                font-family: Inter;
                font-size: 24px;
                font-style: normal;
                font-weight: 300;
                line-height: normal;
                padding-top:10vh;
            }
            .left-side-box .spacer{
                padding-bottom: 10vh;
            }

            .left-side-box .M{
                display: inline-flex;
                flex-direction: column;
                height: 154px;
                min-width: 320px;
                align-items: flex-start;
                flex-shrink: 0;
                background-color: white;
                border-radius: 5%;
                font-family: Inter;
                font-size: 24px;
                font-style: normal;
                font-weight: 300;
                line-height: normal;
                padding-left: 24px;
                padding-right:24px;
                padding-bottom:24px;
            }
            * {box-sizing: border-box;}
            .img-zoom-container {
                position: relative;
            }

            .img-zoom-lens {
            position: absolute;
            border: 1px solid #d4d4d4;
            /*set the size of the lens:*/
            width: 10px;
            height: 10px;
            }

            .img-zoom-result {
            border: 1px solid #d4d4d4;
            /*set the size of the result div:*/
            width: 600px;
            height: 600px;
            }
            
        </style>
        <script>
            // Function to handle form submission
            function handleFormSubmit(event) {
                event.preventDefault(); // Prevent the default form submission
    
                // Get the value from the input field
                //const projectFilepath = document.getElementById('myfile').value;
                //Get the file input element
                const fileInput = document.getElementById('myfile');
                //gets the selected file
                const file=fileInput.files[0]
                // Make an AJAX POST request using fetch
                // fetch('/getFile', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json'
                //     },
                //     body: JSON.stringify({ file: projectFilepath })
                // })
                // .then(response => {
                //     if (!response.ok) {
                //         throw new Error("Network response was not ok: " + response.statusText);
                //     }
                //     return response.json();
                // })
                // .then(data => {
                //     // Handle the response data
                //     alert("Success: " + JSON.stringify(data));
                // })
                // .catch(error => {
                //     // Handle any errors
                //     console.error("Error:", error);
                //     alert("Error: " + error.message);
                // });
                //Checks to see if the file is selected
                if(!file){
                    alert("Please select a file to upload");
                    return;
                }
                //Creates a FormData object to send the file which we also use in the form 
                const formData = new FormData();
                //Append the file to the FormData object
                formData.append('file', file);
                // Make an AJAX POST request using fetch with FormData
                fetch('/getFile', {
                    method: 'POST',
                    body: formData  // Send the FormData object containing the file
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Network response was not ok: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // Handle the response data
                    alert("Success: " + JSON.stringify(data));
                })
                .catch(error => {
                    // Handle any errors
                    console.error("Error:", error);
                    alert("Error: " + error.message);
                });
            }
        </script>
    </head>
    <body>  
        <div class="topbar">
            <img src="/static/images/SiClarity-Logo.png" alt="SiClarity-Logo"/>
            <h1>MELD</h1>
        </div>
        <div class="inner-body">
            <div class="left-side-box">
                <div class="spacer"></div>
                <form class="File_input" method="POST" enctype="multipart/form-data" onsubmit="handleFormSubmit(event)">
                    <label for="myfile">Selected GDS file:</label>
                    <input type="file" class="filepath" id="myfile" name="file" accept=".gds"/>
                    <!-- <input type="submit" value="Upload File"> -->
                    <!-- <button type="submit" onclick="getFile()">Upload File</button> -->
                    <!-- <button type="submit" class="home_button" onclick="callBackendAPI()"> Upload File</button> -->
                    <button type="submit"> Upload File</button>
                </form>
                
                <div class="spacer"></div>
                <form class="M">
                    <h4>M1</h4>
                    <input type="number" class="offset" id="offsetM1" placeholder="Offset" name="Offset_M1">
                    <br>
                    <input type="number" class="height" id="height1" placeholder="Height" name="Height_M1">
                </form>
                <div class="spacer"></div>
                <form class="M">
                    <h4>M2</h4>
                    <input type="number" class="offset" id="offsetM2" placeholder="Offset" name="Offset_M2">
                    <br>
                    <input type="number" class="height" id="heightM2"placeholder="Height" name="Height_M2">
                </form>
                <div class="spacer"></div>
                <form class="M">
                    <h4>V1-V2</h4>
                    <input type="number" class="offset" id="offsetV1V2" placeholder="Offset" name="Offset_V1V2">
                    <br>
                    <input type="number" class="height" id="heightV1V2"placeholder="Height" name="Height_V1V2">
                </form>
                <a href="/" ><button class="home_button"> Go Home</button></a>
            </div>
            <div class="whitespace">
                <div class="img-zoom-container">
                    {% if image_filename %}
                        <!-- Dynamically render the image if a PNG file is found -->
                        <!-- <p>{ url_for('uploads', filename=image_filename) } </p> -->
                        <img src="{{ url_for('uploaded_file', filename=image_filename) }}" width="600" height="480" id="uploaded_image" alt="Uploaded Image">
                        <div id="zresult" class="img-zoom-result"></div>
                    {% else %}
                        <p>No PNG file found.</p>
                    {% endif %}
                </div>
                <button id="bondSearch" onclick="IdentifyUniqueBondingSites()"> Identify Unique Bonding Sites</button>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
          
        <script>
            function IdentifyUniqueBondingSites() {
                const but_search = document.getElementById("bondSearch");

                // Get the new image source from the server
                fetch('/search')  // Make a GET request to /h to get the updated image filename
                .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                    return response.json();  // Parse the response body as JSON
                    })
            }
        </script>

        <script>
        // document.getElementById('bondSearch').addEventListener('click', function(){
        //     alert('Running BondSearch');
        // });
        // function callBackendAPI() {
        //     fetch('/getFile')
        //         .then(response => response.json())
        //         .then(data => {
        //             if (data.success) {
        //                 alert("API call successful! Data: " + JSON.stringify(data.data));
        //             } else {
        //                 alert("Error: " + data.error);
        //             }
        //         })
        //         .catch(error => {
        //             alert("Failed to call API: " + error);
        //         });
        // }
        
        function imageZoom(imgID, resultID) {
            var img, lens, result, cx, cy;
            img = document.getElementById(imgID);
            result = document.getElementById(resultID);
            lens=document.querySelector(".img-zoom-lens");
            if(!lens){
                /* Create lens: */
                lens = document.createElement("DIV");
                lens.setAttribute("class", "img-zoom-lens");
                /* Insert lens: */
                img.parentElement.insertBefore(lens, img);
            }
            /* Calculate the ratio between result DIV and lens: */
            cx = result.offsetWidth / lens.offsetWidth;
            cy = result.offsetHeight / lens.offsetHeight;
            /* Set background properties for the result DIV */
            result.style.backgroundImage = "url('" + img.src + "')";
            result.style.backgroundSize = (img.width * cx) + "px " + (img.height * cy) + "px";
            /* Execute a function when someone moves the cursor over the image, or the lens: */
            lens.addEventListener("mousemove", moveLens);
            img.addEventListener("mousemove", moveLens);
            /* And also for touch screens: */
            lens.addEventListener("touchmove", moveLens);
            img.addEventListener("touchmove", moveLens);
            function moveLens(e) {
                var pos, x, y;
                /* Prevent any other actions that may occur when moving over the image */
                e.preventDefault();
                /* Get the cursor's x and y positions: */
                pos = getCursorPos(e);
                /* Calculate the position of the lens: */
                x = pos.x - (lens.offsetWidth / 2);
                y = pos.y - (lens.offsetHeight / 2);
                /* Prevent the lens from being positioned outside the image: */
                if (x > img.width - lens.offsetWidth) {x = img.width - lens.offsetWidth;}
                if (x < 0) {x = 0;}
                if (y > img.height - lens.offsetHeight) {y = img.height - lens.offsetHeight;}
                if (y < 0) {y = 0;}
                /* Set the position of the lens: */
                lens.style.left = x + "px";
                lens.style.top = y + "px";
                /* Display what the lens "sees": */
                result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
            }
            function getCursorPos(e) {
                var a, x = 0, y = 0;
                e = e || window.event;
                /* Get the x and y positions of the image: */
                a = img.getBoundingClientRect();
                /* Calculate the cursor's x and y coordinates, relative to the image: */
                x = e.pageX - a.left;
                y = e.pageY - a.top;
                /* Consider any page scrolling: */
                x = x - window.pageXOffset;
                y = y - window.pageYOffset;
                return {x : x, y : y};
            }
        }
        if(document.getElementsByName("image_filename")!=null){
                imageZoom("uploaded_image", "zresult")
            }
        // const imageContainer = document.querySelector('.img-zoom-container');
        //     imageContainer.addEventListener('mouseenter', () => {
        //     imageContainer.addEventListener('mousemove', imageZoom("uploaded_image", "zresult"));
        //     });

        //     imageContainer.addEventListener('mouseleave', () => {
        //     imageContainer.removeEventListener('mousemove', imageZoom("uploaded_image", "zresult"));
        // });

        </script>
        <script>
            function refreshImage() {
                const imgElement = document.getElementById("uploaded_image");
                const resultElement=document.getElementById("zresult");

                // Get the new image source from the server
                fetch('/gds', {
                    method: 'POST',
                })  // Make a GET request to /h to get the updated image filename
                .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                    return response.json();  // Parse the response body as JSON
                    })
                .then(data => {
                    // Extract the image filename from the JSON response
                    const imageFilename = data.image_filename;
            
                    if (imageFilename) {
                    // Update the image src with the new filename
                        const imageUrl = `/uploads/${imageFilename}`;
                        imgElement.src = imageUrl;
                        imageZoom("uploaded_image", "zresult");
                    } 
                    else {
                        console.log('No image filename provided');
                    }
                })
                .catch(error => console.error('Error refreshing the image:', error));
            }
        setInterval(refreshImage, 5000);
        
        </script>
    </body>
</html>